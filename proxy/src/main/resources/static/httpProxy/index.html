<!DOCTYPE html>
<html lang="en" style="height: 100%; width: 100%; margin: 0;">
<head>
    <meta charset="UTF-8">
    <title>路由管理</title>
    <script src="vue.js"></script>
    <script src="index.js"></script>
    <!--    <script src="clipboard.min.js"></script>-->
    <link rel="stylesheet" href="index.css"/>
</head>
<body style="height: 100%; width: 100%; margin: 0;">

<div id="app">

    <el-tabs type="border-card">

        <el-tab-pane label="流量">
            <el-row :gutter="20">
                <el-col :span="8">
                    <div>
                        <el-table
                                :height="trafficTableHeight"
                                :data="trafficTableData"
                                stripe
                                highlight-current-row
                                @current-change="handleTrafficTableDataCurrentChange"
                                style="width: 100%">
                            </el-table-column>
                            <el-table-column
                                    show-overflow-tooltip
                                    prop="host"
                                    label="host"
                                    width="180">
                            </el-table-column>
                            <el-table-column
                                    show-overflow-tooltip
                                    prop="url"
                                    label="url">
                            </el-table-column>
                            <el-table-column
                                    prop="cost"
                                    label="cost"
                                    width="100">
                            </el-table-column>
                            <el-table-column
                                    prop="method"
                                    label="method"
                                    width="100">
                            </el-table-column>
                        </el-table>

                    </div>
                </el-col>
                <el-col :span="16">
                    <div style="    box-shadow: 0 2px 4px rgb(0 0 0 / 12%), 0 0 6px rgb(0 0 0 / 4%); padding: 10px; height: calc(50vh - 35px);    overflow-y: auto;box-sizing: border-box;">
                        <el-button type="primary" style="position: absolute; right: 30px;z-index: 1000"
                                   @click="copyReqInfo">复制
                        </el-button>
                        <div>
                            <div>
                                <label style="font-weight: bold ;font-size: large">url: </label>
                                <label style=" ">{{currentTraffic.host+currentTraffic.url}} </label>
                            </div>
                            <div>
                                <label style="font-weight: bold ;font-size: large">请求时间: </label>
                                <label style=" "> {{formatMsToDate(currentTraffic.reqDate)}} </label>
                                <label style="font-weight: bold ;font-size: large">请求体大小: </label>
                                <label style=" ">{{currentTraffic.reqBodyLength}} </label>
                            </div>
                        </div>
                        <el-tabs v-model="reqTrafficShow">
                            <el-tab-pane label="headers" name="headers">

                                <div v-for="headerKey in Object.keys(currentTraffic.requestHeaders)">
                                    <label style="font-weight: bold ;font-size: large">{{headerKey}}: </label>
                                    <label style=" ">{{currentTraffic.requestHeaders[headerKey]}} </label>
                                </div>
                            </el-tab-pane>
                            <el-tab-pane label="body" name="body">
                                <pre style=" white-space: pre-wrap; word-wrap: break-word;">{{currentTraffic.requestBody}}</pre>
                            </el-tab-pane>
                            <el-tab-pane label="raw" name="raw"></el-tab-pane>
                        </el-tabs>
                        <div>

                        </div>
                    </div>


                    <div style="    box-shadow: 0 2px 4px rgb(0 0 0 / 12%), 0 0 6px rgb(0 0 0 / 4%); padding: 10px; height:  calc(50vh - 35px);     overflow-y: auto;box-sizing: border-box;">
                        <el-button type="primary" style="position: absolute; right: 30px; z-index: 1000"
                                   @click="copyRespInfo">复制
                        </el-button>
                        <div>
                            <div>
                                <label style="font-weight: bold ;font-size: large">响应时间: </label>
                                <label style=" "> {{formatMsToDate(currentTraffic.respDate)}} </label>
                                <label style="font-weight: bold ;font-size: large">响应体大小: </label>
                                <label style=" "> {{ currentTraffic.respBodyLength}} </label>
                            </div>
                            <!--                            <div>-->
                            <!--                            </div>-->
                        </div>
                        <el-tabs v-model="respTrafficShow">
                            <el-tab-pane label="headers" name="headers">

                                <div v-for="headerKey in Object.keys(currentTraffic.responseHeaders)">
                                    <label style="font-weight: bold ;font-size: large">{{headerKey}}: </label>
                                    <label style=" ">{{currentTraffic.responseHeaders[headerKey]}} </label>
                                </div>


                            </el-tab-pane>
                            <el-tab-pane label="body" name="body">
                                <pre style=" white-space: pre-wrap; word-wrap: break-word;">
                                     {{currentTraffic.responseBody}}
                                </pre>

                            </el-tab-pane>
                            <el-tab-pane label="raw" name="raw"></el-tab-pane>
                        </el-tabs>
                        <div>

                        </div>
                    </div>
                </el-col>
            </el-row>

        </el-tab-pane>

        <el-tab-pane label="反向代理">


            <el-button type="text" @click="openDialog('add','')">新增</el-button>
            <el-table
                    :data="tableData"
                    border stripe
                    style="width: 100%">

                <el-table-column
                        prop="name"
                        label="名称(唯一)"
                        width="200">
                </el-table-column>
                <el-table-column
                        prop="prefix"
                        label="匹配前缀"
                >
                </el-table-column>
                <el-table-column
                        prop="remote"
                        label="远程地址"
                >
                </el-table-column>
                <el-table-column
                        prop="preview"
                        label="预览"
                >
                </el-table-column>
                </el-table-column>
                <el-table-column
                        prop="order"
                        label="排序(越低优先级越高)"
                >
                </el-table-column>
                <el-table-column
                        prop="remark"
                        label="备注"
                >
                </el-table-column>
                <el-table-column
                        fixed="right"
                        label="操作"
                        width="100">
                    <template slot-scope="scope">
                        <el-button @click="openDialog('edit',scope.row)" type="text" size="small">
                            修改
                        </el-button>
                        <el-button @click="handleDel(scope.row)" type="text" size="small">
                            删除
                        </el-button>
                    </template>
                </el-table-column>
            </el-table>


            <el-dialog :title="editTitle" :visible.sync="dialogFormVisible" width="1200px">
                <el-form :model="form" :rules="rules" ref="form">
                    <el-form-item label="名称" :label-width="formLabelWidth" prop="name">
                        <el-input v-model="form.name" placeholder="请输入名称(保证唯一即可)"></el-input>
                    </el-form-item>
                    <el-form-item label="匹配前缀" :label-width="formLabelWidth" prop="prefix">
                        <el-input v-model="form.prefix"
                                  placeholder="例1: * (表示匹配所有) ; 例2: api ; 例3: api/user"></el-input>
                    </el-form-item>
                    <el-form-item label="远程地址" :label-width="formLabelWidth" prop="remote">
                        <el-input v-model="form.remote"
                                  placeholder="例1: http://192.168.2.1 ; 例2: http://192.168.2.1/api ; 例3: http://192.168.2.1/api/user  "></el-input>
                    </el-form-item>
                    <el-form-item label="模式" :label-width="formLabelWidth">
                        <el-select v-model="form.mode" placeholder="请选择模式" @change="changeMode($event)">
                            <el-option
                                    key="transparent"
                                    label="透传"
                                    value="transparent">
                                <span style="float: left">透传</span>
                                <span style="float: right; color: #8492a6; font-size: 13px">不做任何修改,直接转发</span>
                            </el-option>
                            <el-option
                                    key="enhance"
                                    label="增强"
                                    value="enhance">
                                <span style="float: left">增强</span>
                                <span style="float: right; color: #8492a6; font-size: 13px">可以修改请求和响应</span>
                            </el-option>
                        </el-select>
                    </el-form-item>
                    <el-tabs tab-position="left" v-model="activeEnhanceName" @tab-click="handleEnhanceTabClick"
                             v-show="showEnhanceOption" style="margin-left: 120px;margin-top: -13px;">
                        <el-button type="text" @click="addEnhanceTableData()">新增</el-button>
                        <el-tab-pane label="请求头" name="reqHeader">

                            <el-table stripe
                                      :data="reqHeaderTableData"
                                      @cell-dblclick="openEditColumn">
                                <el-table-column
                                        prop="mode"
                                        label="模式"
                                        width="120">
                                    <template slot-scope="scope">

                                        <el-select v-model="scope.row.mode" placeholder="请选择模式"
                                                   size="small" stype="    width: 100px;">
                                            <el-option
                                                    v-for="item in reqHeaderOptions"
                                                    :key="item.value"
                                                    :label="item.label"
                                                    :value="item.value"
                                            >
                                            </el-option>
                                        </el-select>
                                    </template>
                                </el-table-column>
                                <el-table-column
                                        prop="headerName"
                                        label="请求头名称"
                                        width="180">
                                    <template slot-scope="scope">
                                        <el-input
                                                v-model="scope.row.headerName"
                                                placeholder="请求头名称">
                                            >
                                        </el-input>
                                    </template>
                                </el-table-column>
                                <el-table-column
                                        prop="source"
                                        label="查找目标">
                                    <template slot-scope="scope">
                                        <el-input
                                                v-model="scope.row.source"
                                                placeholder="查找目标">
                                            >
                                        </el-input>
                                    </template>
                                </el-table-column>
                                <el-table-column
                                        prop="content"
                                        label="替换为">
                                    <template slot-scope="scope">
                                        <el-input
                                                v-model="scope.row.content"
                                                placeholder="替换为">
                                            >
                                        </el-input>
                                    </template>
                                </el-table-column>
                                <el-table-column
                                        prop="order"
                                        label="操作"
                                        width="50">
                                    <template slot-scope="scope">
                                        <el-button @click="handleReqHeaderDel(scope.row)" type="text" size="small">
                                            删除
                                        </el-button>
                                    </template>
                                </el-table-column>
                            </el-table>

                        </el-tab-pane>
                        <el-tab-pane label="请求体" name="reqBody">
                            <el-table stripe
                                      :data="reqBodyTableData"
                                      @cell-dblclick="openEditColumn">

                                <el-table-column
                                        prop="source"
                                        label="查找目标">
                                    <template slot-scope="scope">

                                        <el-input
                                                v-model="scope.row.source"
                                                placeholder="查找目标">
                                            >
                                        </el-input>
                                    </template>
                                </el-table-column>
                                <el-table-column
                                        prop="content"
                                        label="替换为">
                                    <template slot-scope="scope">

                                        <el-input
                                                v-model="scope.row.content"
                                                placeholder="替换为">
                                            >
                                        </el-input>
                                    </template>
                                </el-table-column>
                                <el-table-column
                                        prop="order"
                                        label="排序"
                                        width="150"
                                >
                                    <template slot-scope="scope">

                                        <el-input-number size="small" v-model="scope.row.order" :min="1" :max="100"
                                                         label="越小优先级越高"></el-input-number>
                                    </template>
                                </el-table-column>
                                <el-table-column
                                        prop="order"
                                        label="操作"
                                        width="50">
                                    <template slot-scope="scope">
                                        <el-button @click="handleReqBodyDel(scope.row)" type="text" size="small">
                                            删除
                                        </el-button>
                                    </template>
                                </el-table-column>
                            </el-table>

                        </el-tab-pane>
                        <el-tab-pane label="响应头" name="respHeader">
                            <el-table stripe
                                      :data="respHeaderTableData"
                                      @cell-dblclick="openEditColumn">
                                <el-table-column
                                        prop="mode"
                                        label="模式"
                                        width="120">
                                    <template slot-scope="scope">


                                        <el-select v-model="scope.row.mode" placeholder="请选择模式"
                                                   size="small" stype="    width: 100px;">
                                            <el-option
                                                    v-for="item in respHeaderOptions"
                                                    :key="item.value"
                                                    :label="item.label"
                                                    :value="item.value"
                                            >
                                            </el-option>
                                        </el-select>
                                    </template>
                                </el-table-column>
                                <el-table-column
                                        prop="headerName"
                                        label="请求头名称"
                                        width="180">
                                    <template slot-scope="scope">

                                        <el-input
                                                v-model="scope.row.headerName"
                                                placeholder="请求头名称">
                                            >
                                        </el-input>
                                    </template>
                                </el-table-column>
                                <el-table-column
                                        prop="source"
                                        label="查找目标">
                                    <template slot-scope="scope">

                                        <el-input
                                                v-model="scope.row.source"
                                                placeholder="查找目标">
                                            >
                                        </el-input>
                                    </template>
                                </el-table-column>
                                <el-table-column
                                        prop="content"
                                        label="替换为">
                                    <template slot-scope="scope">

                                        <el-input
                                                v-model="scope.row.content"
                                                placeholder="替换为">
                                            >
                                        </el-input>
                                    </template>
                                </el-table-column>
                                <el-table-column
                                        prop="order"
                                        label="操作"
                                        width="50">
                                    <template slot-scope="scope">
                                        <el-button @click="handleRespHeaderDel(scope.row)" type="text" size="small">
                                            删除
                                        </el-button>
                                    </template>
                                </el-table-column>
                            </el-table>


                        </el-tab-pane>
                        <el-tab-pane label="响应体" name="respBody">

                            <el-table stripe
                                      :data="respBodyTableData"
                                      @cell-dblclick="openEditColumn">

                                <el-table-column
                                        prop="source"
                                        label="查找目标">
                                    <template slot-scope="scope">

                                        <el-input
                                                v-model="scope.row.source"
                                                placeholder="查找目标">
                                            >
                                        </el-input>
                                    </template>
                                </el-table-column>
                                <el-table-column
                                        prop="content"
                                        label="替换为">
                                    <template slot-scope="scope">

                                        <el-input
                                                v-model="scope.row.content"
                                                placeholder="替换为">
                                            >
                                        </el-input>
                                    </template>
                                </el-table-column>
                                <el-table-column
                                        prop="order"
                                        label="排序"
                                        width="150"
                                >
                                    <template slot-scope="scope">

                                        <el-input-number size="small" v-model="scope.row.order" :min="1" :max="100"
                                                         label="越小优先级越高"></el-input-number>
                                    </template>
                                </el-table-column>
                                <el-table-column
                                        prop="order"
                                        label="操作"
                                        width="50">
                                    <template slot-scope="scope">
                                        <el-button @click="handleRespBodyDel(scope.row)" type="text" size="small">
                                            删除
                                        </el-button>
                                    </template>
                                </el-table-column>
                            </el-table>
                        </el-tab-pane>
                    </el-tabs>


                    <el-form-item label="备注" :label-width="formLabelWidth">
                        <el-input type="textarea" v-model="form.remark"></el-input>
                    </el-form-item>
                </el-form>
                <div slot="footer" class="dialog-footer">
                    <el-button @click="closeDialog()">取 消</el-button>
                    <el-button type="primary" @click="handleSave() ">确 定</el-button>
                </div>
            </el-dialog>


        </el-tab-pane>

        <el-tab-pane label="agent">
            <div>
                <el-form :inline="true" :model="agentFormInline" class="demo-form-inline">
                    <el-form-item label="进程名">
                        <el-input v-model="agentFormInline.processName" placeholder="进程名(包含即可,优先匹配)"></el-input>
                    </el-form-item>
                    <el-form-item label="进程id">
                        <el-input v-model="agentFormInline.processId" placeholder="进程id(优先匹配进程名)"></el-input>
                    </el-form-item>
                    <el-form-item label="监听端口">
                        <el-input v-model="agentFormInline.listenPort" placeholder="监听端口"></el-input>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" @click="agentOpt('attach')">注入</el-button>
                        <el-button type="primary" @click="agentOpt('reset')">重置</el-button>
                    </el-form-item>
                </el-form>

            </div>
            <div style="    margin: -15px;">
                <el-card id="logsCard" class="box-card" style="">
                    <div slot="header" class="clearfix" style=" margin: -8px -12px;">
                        <span>logs</span>
                        <el-button style="float: right; padding: 3px 0" type="text" @click="clearAgentLogs">清空
                        </el-button>
                    </div>
                    <div id="showAgentLogs" class="text item" style="  margin: -15px;height:calc(100vh - 160px);overflow-y:auto">
                    </div>

                </el-card>
            </div>

        </el-tab-pane>

        <el-tab-pane label="正向代理">正向代理</el-tab-pane>
    </el-tabs>


</div>

<style type="text/css">

</style>
<script>


    const App = {
        data() {
            return {
                agentFormInline: {
                    processName: "demo",
                    processId: 1234,
                    listenPort: 9875
                },
                currentTraffic: {
                    requestHeaders: {},
                    responseHeaders: {}
                },
                reqTrafficShow: "headers",
                respTrafficShow: "headers",
                tableData: [],
                dialogFormVisible: false,
                formLabelWidth: '120px',
                editMode: "save",
                showEnhanceOption: false,
                trafficTableHeight: "calc(100vh - 70px)",
                trafficTableData: [],
                reqHeaderOptions: [
                    {
                        value: 10,
                        label: '添加'
                    },
                    {
                        value: -10,
                        label: '删除'
                    },
                    {
                        value: 0,
                        label: '修改'
                    },
                ],
                respHeaderOptions: [
                    {
                        value: 12,
                        label: '添加'
                    },
                    {
                        value: -12,
                        label: '删除'
                    },
                    {
                        value: 2,
                        label: '修改'
                    },
                ],
                reqHeaderTableData: [],
                respHeaderTableData: [],
                reqBodyTableData: [],
                respBodyTableData: [],
                form: {
                    name: '',
                    prefix: '',
                    remote: '',
                    remark: '',
                    mode: 'transparent',
                    order: 1

                },
                rules: {
                    name: [
                        {required: true, message: '请输入唯一名称', trigger: 'blur'}
                    ],
                    prefix: [
                        {required: true, message: '请输入前缀', trigger: 'blur'}
                    ],
                    remote: [
                        {required: true, message: '请输入远程地址', trigger: 'blur'}
                    ]
                },
                activeEnhanceName: 'reqHeader',
                editTitle: '新增'
            }
        },
        methods: {
            clearAgentLogs() {
                document.querySelector("#showAgentLogs").innerHTML = "";
            },
            agentOpt(opt) {
                console.log(this.agentFormInline);

                let url = "agentApi/attach";
                if (opt == "reset") {
                    url = "agentApi/reset";
                }
                let val = this.agentFormInline.processId;
                let type = "processId";
                if (this.agentFormInline.processName) {
                    type = "processName";
                    val = this.agentFormInline.processName
                }
                let port = this.agentFormInline.listenPort;

                fetch(url, {
                    method: 'post',
                    body: JSON.stringify({
                        type: type,
                        val: val,
                        opt: opt,
                        port: port
                    }),
                    headers: {
                        'Content-Type': 'x-www-form-urlencoded;charset=UTF-8'
                    }
                }).then(res => {
                    let resdata = res.text();
                    return resdata;
                }).then(res => {
                    //console.log("res:", res);
                    if (res == "true") {
                        this.$message({
                            message: '操作成功',
                            type: 'success'
                        });
                        this.getRouteList();
                    } else {
                        this.$message.error('操作失败');
                    }

                });
            },

            copyText(val) {
                const tmpTextElement = document.createElement('textarea');
                document.body.appendChild(tmpTextElement);
                tmpTextElement.value = val;
                tmpTextElement.select();
                if (document.execCommand('copy')) {
                    document.execCommand('copy');
                }
                document.body.removeChild(tmpTextElement);
                this.$message({
                    message: '复制成功',
                    type: 'success'
                });
            },
            copyReqInfo() {
                let val = "";
                if (this.reqTrafficShow == "headers") {
                    let keyArr = Object.keys(this.currentTraffic.requestHeaders);
                    for (let i = 0; i < keyArr.length; i++) {
                        let headerKey = keyArr[i];
                        val += headerKey + ": " + this.currentTraffic.requestHeaders[headerKey] + "\r\n";
                    }
                } else if (this.reqTrafficShow == "body") {
                    val = this.currentTraffic.requestBody;
                } else if (this.reqTrafficShow == "raw") {
                    val = this.currentTraffic.requestRaw;
                }
                this.copyText(val);
            },
            copyRespInfo() {
                let val = "";
                if (this.respTrafficShow == "headers") {
                    let keyArr = Object.keys(this.currentTraffic.responseHeaders);
                    for (let i = 0; i < keyArr.length; i++) {
                        let headerKey = keyArr[i];
                        val += headerKey + ": " + this.currentTraffic.responseHeaders[headerKey] + "\r\n";
                    }
                } else if (this.respTrafficShow == "body") {
                    val = this.currentTraffic.responseBody;
                } else if (this.respTrafficShow == "raw") {
                    val = this.currentTraffic.responseRaw;
                }
                this.copyText(val);
            },
            formatJsonForNotes(json, options) {
                var reg = null,
                    formatted = '',
                    pad = 0,
                    PADDING = '  '; // （缩进）可以使用'\t'或不同数量的空格
                // 可选设置
                options = options || {};
                // 在 '{' or '[' follows ':'位置移除新行
                options.newlineAfterColonIfBeforeBraceOrBracket = (options.newlineAfterColonIfBeforeBraceOrBracket === true) ? true : false;
                // 在冒号后面加空格
                options.spaceAfterColon = (options.spaceAfterColon === false) ? false : true;
                // 开始格式化...
                if (typeof json !== 'string') {
                    // 确保为JSON字符串
                    json = JSON.stringify(json);
                } else {
                    //已经是一个字符串，所以解析和重新字符串化以删除额外的空白
                    json = JSON.parse(json);
                    json = JSON.stringify(json);
                }
                // 在花括号前后添加换行
                reg = /([\{\}])/g;
                json = json.replace(reg, '\r\n$1\r\n');
                // 在方括号前后添加新行
                reg = /([\[\]])/g;
                json = json.replace(reg, '\r\n$1\r\n');
                // 在逗号后添加新行
                reg = /(\,)/g;
                json = json.replace(reg, '$1\r\n');
                // 删除多个换行
                reg = /(\r\n\r\n)/g;
                json = json.replace(reg, '\r\n');
                // 删除逗号前的换行
                reg = /\r\n\,/g;
                json = json.replace(reg, ',');
                // 可选格式...
                if (!options.newlineAfterColonIfBeforeBraceOrBracket) {
                    reg = /\:\r\n\{/g;
                    json = json.replace(reg, ':{');
                    reg = /\:\r\n\[/g;
                    json = json.replace(reg, ':[');
                }
                if (options.spaceAfterColon) {
                    reg = /\:/g;
                    json = json.replace(reg, ': ');
                }
                $.each(json.split('\r\n'), function (index, node) {
                    var i = 0,
                        indent = 0,
                        padding = '';
                    if (node.match(/\{$/) || node.match(/\[$/)) {
                        indent = 1;
                    } else if (node.match(/\}/) || node.match(/\]/)) {
                        if (pad !== 0) {
                            pad -= 1;
                        }
                    } else {
                        indent = 0;
                    }
                    for (i = 0; i < pad; i++) {
                        padding += PADDING;
                    }
                    formatted += padding + node + '\r\n';
                    pad += indent;
                });
                return formatted;
            },
            addZero(num) {
                if (parseInt(num) < 10) {
                    num = "0" + num
                }
                return num
            },
            formatMsToDate(ms) {
                if (ms) {
                    var oDate = new Date(ms),
                        oYear = oDate.getFullYear(),
                        oMonth = oDate.getMonth() + 1,
                        oDay = oDate.getDate(),
                        oHour = oDate.getHours(),
                        oMin = oDate.getMinutes(),
                        oSen = oDate.getSeconds(),
                        milliseconds = oDate.getMilliseconds(),
                        oTime = oYear + '-' + this.addZero(oMonth) + '-' + this.addZero(oDay) + ' ' + this.addZero(oHour) + ':' +
                            this.addZero(oMin) + ':' + this.addZero(oSen) + "." + milliseconds;
                    return oTime;
                } else {
                    return ""
                }
            }
            ,
            handleTrafficTableDataCurrentChange(val) {
                //console.log(val);
                this.currentTraffic = val;
            }
            ,
            initWs() {
                var ws = new WebSocket("ws://" + window.location.host + "/trafficWebsocket/11");
                ws.onmessage = this.wsOnmessage;
            }
            ,
            wsOnmessage(event) {
                //console.log('服务端返回：' + event.data);
                const trafficArr = JSON.parse(event.data);
                const agentInfoArr = trafficArr.filter((traffic) => {
                    return traffic.type == "info" || traffic.type == "error";
                });
                if (agentInfoArr.length > 0) {
                    let div1 = document.querySelector("#showAgentLogs");
                    // let div2 = document.querySelector("#logsCard");
                    for (let i = 0, len = agentInfoArr.length; i < len; i++) {
                        let tmpAgentInfo = agentInfoArr[i];
                        tmpAgentInfo.msg = tmpAgentInfo.msg.replace(/\r\n/g, "<br>");
                        tmpAgentInfo.msg = tmpAgentInfo.msg.replace(/\t/g, "&emsp;");
                        if (tmpAgentInfo.type == "exception") {
                            div1.insertAdjacentHTML('beforeEnd', "<div style='color: red'>" + tmpAgentInfo.msg + "</div>");
                        } else {
                            div1.insertAdjacentHTML('beforeEnd', "" + tmpAgentInfo.msg + "<br />");
                        }

                    }
                    div1.scrollTo(0, div1.scrollHeight);
                }

                const upTrafficArr = trafficArr.filter((traffic) => {
                    return traffic.direction == "up";
                });
                const downTrafficArr = trafficArr.filter((traffic) => {
                    return traffic.direction == "down";
                });
                if (upTrafficArr.length > 0) {
                    this.trafficTableData.push(...upTrafficArr);
                }
                for (let i = 0, len = downTrafficArr.length; i < len; i++) {
                    let tmpDownTraffic = downTrafficArr[i];
                    for (let j = 0, len1 = this.trafficTableData.length; j < len1; j++) {
                        let tmpUpTraffic = this.trafficTableData[j];

                        if (tmpDownTraffic.key == tmpUpTraffic.key) {
                            tmpUpTraffic.respDate = tmpDownTraffic.respDate;
                            tmpUpTraffic.respBodyLength = tmpDownTraffic.respBodyLength;
                            tmpUpTraffic.responseHeaders = tmpDownTraffic.responseHeaders;
                            tmpUpTraffic.responseBody = tmpDownTraffic.responseBody;
                            tmpUpTraffic.cost = tmpUpTraffic.respDate - tmpUpTraffic.reqDate;
                            break;
                        }
                    }
                }
            }
            ,
            filterRule(ruleList, modes) {
                return ruleList.filter((rule) => {
                    for (let i = 0; i < modes.length; i++) {
                        let ti = modes[i];
                        if (rule.mode == ti) {
                            return true;
                        }
                    }
                });
            }
            ,
            getRowKey() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    var r = Math.random() * 16 | 0,
                        v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
                ;
            }
            ,
            addEnhanceTableData() {
                if (this.activeEnhanceName == "reqHeader") {
                    this.addReqHeaderTableData();
                } else if (this.activeEnhanceName == "reqBody") {
                    this.addReqBodyTableData();
                } else if (this.activeEnhanceName == "respHeader") {
                    this.addRespHeaderTableData();
                } else if (this.activeEnhanceName == "respBody") {
                    this.addRespBodyTableData();
                }
            }
            ,

            handleRespHeaderDel(row) {
                //console.log(row);
                for (let i = 0; i < this.respHeaderTableData.length; i++) {
                    if (this.respHeaderTableData[i].key == row.key) {
                        this.respHeaderTableData.splice(i, 1);
                    }
                }
            }
            ,
            addRespHeaderTableData() {
                this.respHeaderTableData.push({
                    mode: 12,
                    headerName: "",
                    source: "",
                    content: "",
                    order: 1,
                    edit: true,
                    key: this.getRowKey()
                });
            }
            ,
            handleRespBodyDel(row) {
                //console.log(row);
                for (let i = 0; i < this.respBodyTableData.length; i++) {
                    if (this.respBodyTableData[i].key == row.key) {
                        this.respBodyTableData.splice(i, 1);
                    }
                }
            }
            ,
            addRespBodyTableData() {
                this.respBodyTableData.push({
                    mode: 3,
                    headerName: "",
                    source: "",
                    content: "",
                    order: 1,
                    edit: true,
                    key: this.getRowKey()
                });
            }
            ,
            handleReqHeaderDel(row) {
                //console.log(row);
                for (let i = 0; i < this.reqHeaderTableData.length; i++) {
                    if (this.reqHeaderTableData[i].key == row.key) {
                        this.reqHeaderTableData.splice(i, 1);
                    }
                }
            }
            ,
            addReqHeaderTableData() {
                this.reqHeaderTableData.push({
                    mode: 10,
                    headerName: "",
                    source: "",
                    content: "",
                    order: 1,
                    edit: true,
                    key: this.getRowKey()
                });
            }
            ,
            handleReqBodyDel(row) {
                //console.log(row)
                for (let i = 0; i < this.reqBodyTableData.length; i++) {
                    if (this.reqBodyTableData[i].key == row.key) {
                        this.reqBodyTableData.splice(i, 1);
                    }
                }
            }
            ,
            addReqBodyTableData() {
                this.reqBodyTableData.push({
                    mode: 1,
                    headerName: "",
                    source: "",
                    content: "",
                    order: 1,
                    edit: true,
                    key: this.getRowKey()
                });
            }
            ,
            openEditColumn(row, column, cell, event) {
                //console.log(row, cell);
                row.edit = true;
            }
            ,
            // 表格数据编辑保存并关闭编辑
            editColumnData(row, column) {
                // 关闭表格编辑
                //console.log(row, column)
            }
            ,
            handleEnhanceTabClick(tab, event) {
                //console.log(tab, event);
            }
            ,
            changeMode(value) {
                //console.log(value);
                if (value == "enhance") {
                    this.showEnhanceOption = true;
                } else {
                    this.showEnhanceOption = false;
                }
            }
            ,
            closeDialog() {
                this.dialogFormVisible = false;
                this.form.name = "";
                this.form.prefix = "";
                this.form.remote = "";
                this.form.remark = "";
            }
            ,
            openDialog(mode, row) {
                this.dialogFormVisible = true;

                if (mode == "add") {
                    this.editMode = 'add'
                    this.form.name = "";
                    this.form.prefix = "";
                    this.form.remote = "";
                    this.form.remark = "";
                    this.editTitle = "添加";
                    this.reqHeaderTableData = [];
                    this.respBodyTableData = [];
                    this.reqHeaderTableData = [];
                    this.respBodyTableData = [];
                } else {
                    this.editMode = 'edit'
                    this.form.name = row.name;
                    this.form.prefix = row.prefix;
                    this.form.remote = row.remote;
                    this.form.remark = row.remark;
                    this.form.mode = row.mode;
                    this.editTitle = "修改";
                    this.reqHeaderTableData = this.filterRule(row.ruleList, [0, 10, -10]);
                    this.reqBodyTableData = this.filterRule(row.ruleList, [1]);
                    this.respHeaderTableData = this.filterRule(row.ruleList, [2, 12, -12]);
                    this.respBodyTableData = this.filterRule(row.ruleList, [3]);
                    //console.log(this.reqHeaderTableData);
                    //console.log(this.reqBodyTableData);
                    //console.log(this.respHeaderTableData);
                    //console.log(this.respBodyTableData);
                }
            }
            ,
            handleSave() {
                var url = "";
                var name = this.form.name;
                var prefix = this.form.prefix;
                var remote = this.form.remote;
                var mode = this.form.mode;
                var remark = this.form.remark;
                if (this.editMode == "add") {
                    url = "routeApi/addProxy"
                } else {
                    url = "routeApi/editProxy"
                }
                var rules = this.reqHeaderTableData.concat(this.reqBodyTableData).concat(this.respHeaderTableData).concat(this.respBodyTableData);
                //console.log()
                fetch(url, {
                    method: 'post',
                    body: JSON.stringify({
                        name: name,
                        prefix: prefix,
                        remote: remote,
                        remark: remark,
                        mode: mode,
                        ruleList: rules
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(res => {
                    let resdata = res.text();
                    return resdata;
                }).then(res => {
                    //console.log("res:", res);
                    if (res == "true") {
                        this.$message({
                            message: '操作成功',
                            type: 'success'
                        });
                        this.getRouteList();
                    } else {
                        this.$message.error('操作失败');
                    }

                });
                this.dialogFormVisible = false;

            }
            ,
            handleDel(row) {
                //console.log("row:", row);

                fetch("routeApi/delProxy", {
                    method: 'post',
                    body: JSON.stringify({
                        name: row.name
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(res => {
                    let resdata = res.text();
                    return resdata;
                }).then(res => {
                    //console.log("res:", res);
                    this.getRouteList();
                });
            }
            ,
            getRouteList() {
                var vue = this;
                fetch("routeApi/getRouteList", {
                    "method": "POST",
                    body: JSON.stringify({}),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(res => {
                    let resdata = res.json();
                    return resdata;
                }).then(res => {
                    //console.log("res:", res);
                    vue.tableData = res;
                });
            }
        },
        mounted: function () {
            //console.log("页面打开了!");

            this.getRouteList();
            this.initWs();

        }
    }
    var Ctor = Vue.extend(App);
    new Ctor().$mount('#app');
    // const app = Vue.createApp(App);
    // app.use(ElementPlus);
    // app.mount("#app");

</script>
</body>

</html>